<!DOCTYPE html>
<html>
<head>
  <!--<script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js" integrity="sha512-q/dWJ3kcmjBLU4Qc47E4A9kTB4m3wuTY7vkFJDTZKjTs8jhyGQnaUrxa0Ytd0ssMZhbNua9hE+E7Qv1j+DyZwA==" crossorigin="anonymous"></script> -->
<link rel="stylesheet" type="text/css" href="./src/style.css" />
<script type="text/javascript" src="/src/socket.io.js"></script>
<script type="text/javascript" src="/src/utils.js"></script>
<script src="/src/jsonpack.js"></script>
<style>
body {
  padding-top: 96px;
}
.team {
  border: 1px solid var(--text-1);
  padding: 5px;
  color:var(--text-1);
  width: fit-content;
  float: right;
  margin: 2px;
}
.teamgreen {
  border: 1px solid var(--text-1);
  padding: 5px;
  color:var(--text-1);
  width: fit-content;
  float: right;
  margin: 2px;
  background-color: #059100;
}
button {
  float: left;
}
.topnav2 {
  
}
</style>
</head>

<body>
<div class="topnav">
  <a class="active" href="/data">Data</a>
  <a href="/scout/match">Scouting</a>
  <a href="/fileupload">Send</a>
  <a href="/qrscan">Scan</a>
  <a href="/tba">TBA</a>
  <input id="username">
  <select id="events" onchange="location.reload()">
    <option disabled selected value>select</option>
  </select>
  <select id="position">
    <option disabled selected value>select</option>
    <option value="red-1">Red-1</option>
    <option value="red-2">Red-2</option>
    <option value="red-3">Red-3</option>
    <option value="blue-1">Blue-1</option>
    <option value="blue-2">Blue-2</option>
    <option value="blue-3">Blue-3</option>
  </select>
</div>
<div class="topnav" style="top:48px;">
  <a class="active" href="/">Dashboard</a>
  <a href="/data/leaderboard">Leaderboard</a>
  <a href="/data/predictor">Predictor</a>
  <a href="/data/selector">Selector</a>
</div>
<table id='matchTable' style="display:none;float: left;"></table>
<div id="teams"></div>
<script>
const matchTable = getel('matchTable')
const event = getel('events')

let fileList = []
let matchData = []
let teamList = []

onOpen(function(){})
onUsername(function(){})
onEventList(function(){
  socket.emit("getFilesInEvent", event.value)
  socket.emit("readFromFile", event.value, 'matches.jsonpack')
  socket.emit("getTeams", event.value)
})
onMatchPosition(function(){})

socket.on('eventFileList', (data)=>{
  fileList = data.split('•')
  setTeamList()
  setMatchTable()
})

socket.on('eventFileContent',(dirname, filename, data)=>{
  console.log(data)
  if(data == ''){return}
  switch(filename.split('-')[0]) {
    case 'matches.jsonpack':
      matchData = jsonpack.unpack(data)
      setMatchTable()

  }
})

function setMatchTable(){
  if(matchData == []){return}
  if(fileList == []){return}
  let line = ''
  line += "<tr>"
  line += "<th>key</th>"
  line += "<th>Red 1</th>"
  line += "<th>Red 2</th>"
  line += "<th>Red 3</th>"
  line += "<th>Blue 1</th>"
  line += "<th>Blue 2</th>"
  line += "<th>Blue 3</th>"
  line += "</th>"

  function getTableElem(match, alliance, num){
    th = '<th'

    filename = `matchscout-${match.key}-${alliance}-${num}.jsonpack`

    if(fileList.includes(filename)){
      th += " class='green'>"
    }else{
      th += '>'
    }

    th += match[alliance][num-1]

    return th + '</th>'
  }

  for(i=0; i<matchData.length; i++){
    line += "<tr>"
    line += "<th>"+matchData[i].key+"</th>"
    line += getTableElem(matchData[i], 'red', 1)
    line += getTableElem(matchData[i], 'red', 2)
    line += getTableElem(matchData[i], 'red', 3)
    line += getTableElem(matchData[i], 'blue', 1)
    line += getTableElem(matchData[i], 'blue', 2)
    line += getTableElem(matchData[i], 'blue', 3)
    line += "</th>"
  }
  matchTable.innerHTML = line
  matchTable.style.display = ""
}

socket.on('teamList', (data)=>{
  teamList = data.split('•')
  setTeamList()
})

function setTeamList(){
  if(fileList.length == 0){return}
  if(teamList.length == 0){return}
  if(getel('teams').innerHTML != []){return}

  for(i=0;i<teamList.length;i++){
    team = '<div'
    filename = `pitscout-${teamList[i]}.jsonpack`
    if(fileList.includes(filename)){
      team += " class='teamgreen'>"
    }else{
      team += " class='team'>"
    }

    team += teamList[i]

    getel('teams').innerHTML += team + '</div>'
  }
}

</script>
    
</body>
</html>