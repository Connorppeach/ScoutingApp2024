<!DOCTYPE html>
<html>
<head>
  <!--<script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js" integrity="sha512-q/dWJ3kcmjBLU4Qc47E4A9kTB4m3wuTY7vkFJDTZKjTs8jhyGQnaUrxa0Ytd0ssMZhbNua9hE+E7Qv1j+DyZwA==" crossorigin="anonymous"></script> -->
<link rel="stylesheet" type="text/css" href="/src/style.css" />
<link rel="stylesheet" type="text/css" href="/src/pico.min.css" />
<script type="text/javascript" src="/src/socket.io.js"></script>
<script type="text/javascript" src="/src/utils.js"></script>
<script src="/src/jsonpack.js"></script>
<style>
  body {
    padding-top: 96px;
  }
</style>
</head>

<body>
<div class="topnav">
  <a href="/data">Data</a>
  <a class="active" href="/scout/match">Scouting</a>
  <a href="/fileupload">Send</a>
  <a href="/qrscan">Scan</a>
  <a href="/tba">TBA</a>
  <input id="username">
  <select id="events" onchange="location.reload()">
    <option disabled selected value>select</option>
  </select>
  <select id="position" onchange="location.reload()">
    <option disabled selected value>select</option>
    <option value="red-1">Red-1</option>
    <option value="red-2">Red-2</option>
    <option value="red-3">Red-3</option>
    <option value="blue-1">Blue-1</option>
    <option value="blue-2">Blue-2</option>
    <option value="blue-3">Blue-3</option>
  </select>
</div>
<div class="topnav" style="top:48px;">
  <a class="active" href="/scout/match">Match Scouting</a>
  <a href="/scout/pit">Pit Scouting</a>
</div>
<div class="container">
  <select id="matchlist" onchange="setMatch()">
    <option disabled selected value> -- select an option -- </option>
  </select>
  <button onclick="prevMatch()" class="third">Prev</button>
  <button onclick="saveData()" class="third">Save</button>
  <button onclick="nextMatch()" class="third">Next</button>
  <br>
  <div id="scoutingDiv" style="display: none;">
    <h3 id="teamKey">Team: </h3>
    <h3 id="teamPosition">Position: </h3>
    <label for="winningAlliance">winning Alliance:</label>
    <select id="winningAlliance">
      <option disabled selected value>select</option>
      <option value="">Red</option>
      <option value="">Blue</option>
    </select>
    <br>
    <label for="blueScore" class="left">Blue Score</label>
    <label for="redScore" class="right">Red Score</label>
    <br>
    <input type="number" id="blueScore" placeholder="Blue Score" class="half">
    <input type="number" id="redScore" placeholder="Red Score" class="half">
    <br>
    <label for="robotCondition" class="left">Robot condition</label>
    <label for="scoreArea" class="right">Score area</label>
    <br>
    <select id="robotCondition" class="half">
      <option selected value="">Fully functional</option>
      <option value="broken?">Somthing was broken (Maybe)?</option>
      <option value="broken">Somthing was broken</option>
      <option value="somework">Did not work during part of the match</option>
      <option value="notwork">Did not work at all</option>
    </select>
    <select id="scoreArea" class="half">
      <option value="2">Exclusively in speaker</option>
      <option value="1">Mostly in speaker</option>
      <option selected value="0">Both</option>
      <option value="-1">Mostly in AMP</option>
      <option value="-2">Exclusively in AMP</option>
    </select>
    <br>
    <label for="autoPerformance" class="left">Auto performance</label>
    <label for="teleopPerformance" class="right">Teleop performance</label>
    <br>
    <select id="autoPerformance" class="half">
      <option value="4">Many rings</option>
      <option value="2">One ring</option>
      <option value="1">Auto taxi</option>
      <option selected value="0">No auto (Joe Johnson)</option>
    </select>
    <select id="teleopPerformance" class="half">
      <option value="2">Far above average</option>
      <option value="1">Above average</option>
      <option selected value="0">Average</option>
      <option value="-1">Below average</option>
      <option value="-2">Far below average</option>
    </select>
    <br>
    <label for="overallPerformance" class="left">Overall performance</label>
    <select id="overallPerformance">
      <option value="2">Far above average</option>
      <option value="1">Above average</option>
      <option selected value="0">Average</option>
      <option value="-1">Below average</option>
      <option value="-2">Far below average</option>
    </select>
    <br>
    <textarea id="teamNotes" placeholder="Notes" style="width: 500px;height: 500px;float: left;"></textarea>
    <div style="display: inline;">
      <p>Prompts:</p>
      <p>How fast was the robot able to score?</p>
      <p>Did anything unusual happen?</p>
      <p>Did the robot blow up?</p>
    </div>
  </div>
</div>

<script>
const matchsel = getel('matchlist')
const scoutingDiv = getel('scoutingDiv')

const teamKey = getel('teamKey')
const teamPosition = getel('teamPosition')
const winningAlliance = getel('winningAlliance')
const blueScore = getel('blueScore')
const redScore = getel('redScore')
const robotCondition = getel('robotCondition')
const scoreArea = getel('scoreArea')
const autoPerformance = getel('autoPerformance')
const teleopPerformance = getel('teleopPerformance')
const overallPerformance = getel('overallPerformance')
const teamNotes = getel('teamNotes')

const username = getel('username')

let matches = []
let curPosition = ''
let curMatch = ''
let selEvent = ''

let matchIndex = -1
let alliance = ''
let position = 0
let teamName = ''


onOpen(function(){
  socket.emit('getCurMatch')
})
onUsername(function(){})
onEventList(function(){
  selEvent = getel('events').value
  if(selEvent != ""){
    socket.emit('readFromFile', selEvent, 'matches.jsonpack')
  }
})
onMatchPosition(function(pos){
  curPosition = pos
  refreshData()
})

socket.on('curMatch', (match)=>{
  curMatch = match
  if(matchsel.children.length != 1){
    matchsel.value = curMatch
  }
})

socket.on('eventFileContent',(dirname, filename, data)=>{
  console.log(data)
  switch(filename.split('-')[0]) {
    case 'matches.jsonpack':
      matches = jsonpack.unpack(data)
      matchsel.innerHTML = '<option disabled selected value> -- select an option -- </option>'
      for(let i=0;i<matches.length;i++){
        matchsel.innerHTML += `<option value='${matches[i].key}'>${matches[i].key}</option>`
      }
      matchsel.value = curMatch
      refreshData()
    case 'matchscout':
      teamKey.innerText = 'Team: '+teamName
      teamPosition.innerText = 'Position: '+curPosition
      
      winningAlliance.children[1].value = 'true'
      winningAlliance.children[1].innerText = alliance
      winningAlliance.children[2].value = 'false'
      winningAlliance.children[2].innerText = (alliance=='blue' ? 'red' : 'blue')

      if(data != ''){
        matchData = jsonpack.unpack(data)
        winningAlliance.value = matchData.win
        blueScore.value = matchData.blueScore
        redScore.value = matchData.redScore
        scoreArea.value = matchData.scoreArea
        robotCondition.value = matchData.robotCondition
        autoPerformance.value = matchData.autoPerformance
        teleopPerformance.value = matchData.teleopPerformance
        overallPerformance.value = matchData.overallPerformance
        teamNotes.value = matchData.notes
      }else{
        winningAlliance.value = ''
        blueScore.value = ''
        redScore.value = ''
        scoreArea.value = 0
        robotCondition.value = ''
        autoPerformance.value = 0
        teleopPerformance.value = 0
        overallPerformance.value = 0
        teamNotes.value = ''
      }

      scoutingDiv.style.display = ""
    break;
  }
})

function setMatch(){
  curMatch = matchsel.value
  socket.emit('setCurMatch', curMatch)
  refreshData()
}

function findMatchIndex(){
  for(let i=0;i<matches.length;i++){
    if(matches[i].key==curMatch){return i}
  }
}

function nextMatch(){
  if(matches == []){return}
  index = findMatchIndex()
  if(index >= matches.length-1){return}
  matchsel.value = matches[index+1].key
  setMatch()
}

function prevMatch(){
  if(matches == []){return}
  index = findMatchIndex()
  if(index <= 0){return}
  matchsel.value = matches[index-1].key
  setMatch()
}

function refreshData(){
  if(curPosition == ''){return}
  if(curMatch == ''){return}
  if(matches == []){return}
  matchIndex = findMatchIndex()
  alliance = curPosition.split('-')[0]
  position = curPosition.split('-')[1]
  teamName = matches[matchIndex][alliance][position-1]

  socket.emit('readFromFile', selEvent, `matchscout-${curMatch}-${curPosition}.jsonpack`)
  scoutingDiv.style.display = "none"
}

function saveData(){
  if(matchlist.value == ''){return}
  data = jsonpack.pack({
    name: username.value,
    alliance: alliance,
    position: Number(position),
    team: teamName,
    win: (winningAlliance.value=='True'),
    blueScore: Number(blueScore.value),
    redScore: Number(redScore.value),
    scoreArea: Number(scoreArea.value),
    robotCondition: (robotCondition.value),
    autoPerformance: Number(autoPerformance.value),
    teleopPerformance: Number(teleopPerformance.value),
    overallPerformance: Number(overallPerformance.value),
    notes: teamNotes.value
  })
  socket.emit('writeToFile', selEvent, `matchscout-${curMatch}-${curPosition}.jsonpack`, data)
  alert('Saved!')
}

</script>
    
</body>
</html>
