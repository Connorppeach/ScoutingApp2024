<head>
<link rel="stylesheet" type="text/css" href="./src/style.css" />
<script src="/src/jsonpack.js"></script>
<script type="text/javascript" src="/src/socket.io.js"></script>
<script type="text/javascript" src="/src/utils.js"></script>
<style>
  #indicator {
    display:inline
  }
</style>
</head>
<body>
<div class="topnav">
  <a href="/">Data</a>
  <a href="/matchscout">Match Scouting</a>
  <a href="/pitscout">Pit Scouting</a>
  <a href="/fileupload">Send</a>
  <a href="/qrscan">Scan</a>
  <a class="active" href="/tba">Init</a>
</div>
<select name="year" id="year" onchange="year = getel('year').value; getEventsByYear()">
  <option disabled selected value> -- select an option -- </option>
  <option value="2020">2020</option>
  <option value="2021">2021</option>
  <option value="2022">2022</option>
  <option value="2023">2023</option>
  <option value="2024">2024</option>
  <option value="2025">2025</option>
</select>

<button id='back' onclick="window.location.reload(false)">Back</button>
<button id='save' onclick="sendToServer()">Save</button>
<p id="indicator"></p>
<table id='table'></table>

<script>

const TBAip = "https://www.thebluealliance.com/api/v3"
const authkey = "tjEKSZojAU2pgbs2mBt06SKyOakVhLutj3NwuxLTxPKQPLih11aCIwRIVFXKzY4e"
const table = getel('table')

async function getTBA(path, func){
  const response = await fetch(TBAip+path, {
    method: 'GET',
    headers: {
      'X-TBA-Auth-Key': authkey
    }
  });

  const data = await response.json()
  console.log(data)
  func(data)
}

onOpen(function(){})

let alliances = []
let matchdata
let year
let eventkey

function sendToServer(){
  socket.emit("writeToFile", eventkey, 'match.jsonpack', jsonpack.pack(alliances))
  alert("Saved!")
}

getel('year').selectedIndex = 0
getel('save').style.display = "none"
getel('back').style.display = "none"

function getEventsByYear(){
  getel('year').style.display = "none"
  getTBA("/events/"+year, function(data) {
    let line = ''
    line += "<tr>"
    line += "<th>Country</th>"
    line += "<th>City</th>"
    line += "<th>Type</th>"
    line += "<th>Name</th>"
    line += "<th>Start</th>"
    line += "<th>End</th>"
    line += "</tr>"

    for(i=0; i < data.length; i++){
      line += `<tr onclick="eventkey='${data[i].key}';getMatchesByEvent()">`
      line += "<th>"+data[i].country+"</th>"
      line += "<th>"+data[i].city+"</th>"
      line += "<th>"+data[i].event_type_string+"</th>"
      line += "<th>"+data[i].name+"</th>"
      line += "<th>"+data[i].start_date+"</th>"
      line += "<th>"+data[i].end_date+"</th>"
      line += "</tr>"
    }
    table.innerHTML = line
    getel('table').style.display = ""
    getel('back').style.display = ""
    window.scrollTo(0, 0)
  })
}

function getMatchesByEvent(){
  getTBA("/event/"+eventkey+"/matches", function(data){
    let line = ''
    line += "<tr>"
    line += "<th>key</th>"
    line += "<th>Red 1</th>"
    line += "<th>Red 2</th>"
    line += "<th>Red 3</th>"
    line += "<th>Blue 1</th>"
    line += "<th>Blue 2</th>"
    line += "<th>Blue 3</th>"
    line += "</th>"

    alliances = []

    for(i=0; i<data.length; i++){
      if(data[i].comp_level != "qm"){continue}

      alliances[data[i].key.split('qm')[self.length+1]-1] = {
        key: data[i].key,
        red: data[i].alliances.red.team_keys,
        blue: data[i].alliances.blue.team_keys
      }
    }

    console.log(alliances)
    
    for(i=0; i<alliances.length; i++){
      line += "<tr>"
      line += "<th>"+alliances[i].key+"</th>"
      line += "<th class='red'> "+alliances[i].red[0]+" </th>"
      line += "<th class='red'> "+alliances[i].red[1]+" </th>"
      line += "<th class='red'> "+alliances[i].red[2]+" </th>"
      line += "<th class='blue'> "+alliances[i].blue[0]+" </th>"
      line += "<th class='blue'> "+alliances[i].blue[1]+" </th>"
      line += "<th class='blue'> "+alliances[i].blue[2]+" </th>"
      line += "</th>"
    }
    table.innerHTML = line
    getel('save').style.display = ""
    window.scrollTo(0, 0) 
  })
}

async function getTeamData(){
}

</script>
</body>
