<!DOCTYPE html>
<html>
<head>

<link rel="stylesheet" type="text/css" href="./src/style.css" />
<script type="text/javascript" src="/src/utils.js"></script>
<script src="/src/jsonpack.js"></script>
<style>
  #indicator {
    display:inline
  }
</style>
</head>

<body>
<div class="topnav">
  <a href="/">Data</a>
  <a href="/matchscout">Match Scouting</a>
  <a href="/pitscout">Pit Scouting</a>
  <a class="active" href="/fileupload">Send</a>
  <a href="/qrscan">Scan</a>
  <a href="/tba">Init</a>
</div>

<select id="matchdropdown" onchange="listFileOfMatch()">
  <option disabled selected value> -- select an option -- </option>
</select>
<button id="loadbutton" style="display:none;" onclick="getData()">Load</button>
<p id="indicator">Getting Matches...</p>
<table id='table' style="display:none;"></table>
<iframe id='iframe' style="display:none;"></iframe>

<script>
  const matchdropdown = getel('matchdropdown')
  const table = getel('table')
  const loadbutton = getel('loadbutton')
  const iframe = getel('iframe')
  const indicator = getel('indicator')

  let filenames = []
  let returnData = []

  onOpen(function(){
    ws.send("getMatches")
  })

  onMessage(function(event){
    if(event.data == ""){return}

    let data = event.data.split('§')
    switch(data[0]){
      case "MatchList":
        matches = data[1].split('•')
        line = ""
        for(i=0; i<matches.length;i++){
          line += `<option value="${matches[i]}">${matches[i]}</option>`
        }
        matchdropdown.innerHTML += line
        indicator.innerText = ""
        break;
      case "MatchFileList":
        files = data[2].split('•')
        line = "<tr>"
        line += "<th></th>"
        line += "<th>File</th>"
        line += "</tr>"
        for(i=0;i<files.length;i++){
          line += "<tr>"
          line += `<th><input type='checkbox' onChange='toggleFile("${files[i]}")'></th>`
          line += `<th>${files[i]}</th>`
          line += "</tr>"
        }
        table.innerHTML = line
        table.style.display = ""
        loadbutton.style.display = ""
        indicator.innerText = ""
        
        break
      case "MatchFileContent":
        returnData.push(data[3])
        if(returnData.length == filenames.length){
          table.style.display = "none"
          loadbutton.style.display = "none"
          iframe.style.display = ""
          iframe.src = "/qrgen"
          iframe.onload = function() {
            let filedata = "MatchFileContent§"+matchdropdown.value+"§"
            for(i=0;i<returnData.length;i++){
              filedata += filenames[i]+"‹"+returnData[i]
              if(i+1 != returnData.length){
                filedata += "×"
              }
            }
            iframe.contentWindow.compdata = filedata
          }
        }
        break
      default:
        console.log(event.data)
        break;
    }
  })

  function listFileOfMatch(){
    indicator.innerText = `Getting files of: ${matchdropdown.value}`
    matchdropdown.style.display = "none"
    ws.send("getFilesInMatch§"+matchdropdown.value)
  }

  function toggleFile(str){
    const index = filenames.indexOf(str)
    if(index > -1){
      filenames.remove(str)
    }else{
      filenames.push(str)
    }
  }
  
  async function getData(){
    returnData = []
    for(i=0;i<filenames.length;i++){
      indicator.innerText = `Getting filedata: ${filenames[i]}`
      ws.send("readFromFile§"+matchdropdown.value+"§"+filenames[i])
      await sleep(300);
    }
    
  }
  
</script>
    
</body>
</html>
